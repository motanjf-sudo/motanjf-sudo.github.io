<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#667eea" />
  <title>Amirtaha Chat + AI</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --primary: #6366f1;
      --secondary: #8b5cf6;
      --bg: #0f172a;
      --bg2: #1e293b;
      --bg3: #334155;
      --text: #f1f5f9;
      --sub: #cbd5e1;
      --border: #475569;
      --danger: #ef4444;
      --ok: #10b981;
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Tahoma, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 14px;
    }
    .app {
      width: min(1320px, 100%);
      height: 92vh;
      background: var(--bg);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 16px 60px rgba(0,0,0,.3);
      display: flex;
      flex-direction: column;
    }
    .hidden { display: none !important; }

    /* Auth */
    .auth-wrap {
      height: 100%;
      display: grid;
      place-items: center;
      padding: 16px;
    }
    .auth-box {
      width: min(520px, 100%);
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
    }
    .title {
      font-size: 1.7rem;
      font-weight: 800;
      margin-bottom: 8px;
      text-align: center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { text-align: center; color: var(--sub); margin-bottom: 16px; }
    .tabs {
      display: flex;
      gap: 8px;
      background: var(--bg3);
      padding: 5px;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .tab {
      flex: 1;
      border: none;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      color: var(--sub);
      background: transparent;
      font-weight: 700;
    }
    .tab.active {
      color: #fff;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    .form { display: none; }
    .form.active { display: block; }
    .fg { margin-bottom: 12px; }
    .fg label { display: block; margin-bottom: 6px; font-size: .92rem; }
    .input, select, textarea {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 11px;
      font-size: 15px;
      font-family: inherit;
    }
    .input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--primary);
      border-color: var(--primary);
    }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 11px 14px;
      cursor: pointer;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    .btn.full { width: 100%; }
    .btn.secondary {
      background: var(--bg3);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn.danger { background: var(--danger); }
    .msg { margin-top: 10px; font-size: .9rem; min-height: 20px; }
    .msg.error { color: #fca5a5; }
    .msg.ok { color: #6ee7b7; }

    /* Chat layout */
    .chat-wrap { height: 100%; display: grid; grid-template-columns: 340px 1fr; }
    .sidebar {
      background: var(--bg2);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .side-top {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .me {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .me-name { font-weight: 800; }
    .me-sub { color: var(--sub); font-size: .82rem; }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .groups {
      flex: 1;
      overflow: auto;
      padding: 10px;
    }
    .group {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .group.active { outline: 2px solid var(--primary); }
    .group small { color: var(--sub); }

    .main {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .messages {
      flex: 1;
      overflow: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--bg);
    }
    .bubble {
      max-width: min(78%, 680px);
      border: 1px solid var(--border);
      background: var(--bg2);
      border-radius: 12px;
      padding: 10px 12px;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .bubble.me {
      align-self: flex-end;
      color: #fff;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    .meta {
      font-size: .75rem;
      opacity: .82;
      margin-bottom: 4px;
    }

    .composer {
      border-top: 1px solid var(--border);
      background: var(--bg2);
      padding: 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: end;
    }
    .composer textarea { resize: none; min-height: 50px; max-height: 150px; }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.75);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 14px;
      z-index: 5000;
    }
    .modal.show { display: flex; }
    .modal-card {
      width: min(780px, 100%);
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      max-height: 90vh;
      overflow: auto;
    }
    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .ai-list {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 260px;
      max-height: 400px;
      overflow: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }
    .ai-msg {
      border-radius: 10px;
      padding: 9px 10px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.7;
    }
    .ai-msg.user {
      align-self: flex-end;
      max-width: 88%;
      color: #fff;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    .ai-msg.bot {
      align-self: flex-start;
      max-width: 92%;
      background: var(--bg3);
      border: 1px solid var(--border);
    }
    .ai-msg.note {
      align-self: center;
      max-width: 95%;
      color: #fbbf24;
      background: rgba(245,158,11,.1);
      border: 1px solid var(--warn);
    }

    .row { display: flex; gap: 8px; }
    .row > * { flex: 1; }

    .copy-fab {
      position: fixed;
      left: 14px;
      bottom: 14px;
      z-index: 6000;
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
      border-radius: 999px;
      padding: 11px 14px;
      font-weight: 800;
      cursor: pointer;
    }
    .copy-fab:hover { background: var(--primary); border-color: var(--primary); }

    @media (max-width: 920px) {
      .chat-wrap { grid-template-columns: 1fr; }
      .sidebar { order: 2; height: 45vh; border-left: none; border-top: 1px solid var(--border); }
      .main { order: 1; height: 47vh; }
      .actions { grid-template-columns: 1fr; }
      .bubble { max-width: 90%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Auth -->
    <section id="authSection" class="auth-wrap">
      <div class="auth-box">
        <h1 class="title">ğŸ’¬ Amirtaha Chat</h1>
        <p class="subtitle">Ú†Øª Ø¢Ù†Ù„Ø§ÛŒÙ† + Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Gemini</p>

        <div class="tabs">
          <button id="tabLogin" class="tab active" type="button">ÙˆØ±ÙˆØ¯</button>
          <button id="tabSignup" class="tab" type="button">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
        </div>

        <form id="loginForm" class="form active">
          <div class="fg">
            <label for="loginUsername">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
            <input id="loginUsername" class="input" required autocomplete="username" />
          </div>
          <div class="fg">
            <label for="loginPassword">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input id="loginPassword" type="password" class="input" required autocomplete="current-password" />
          </div>
          <button class="btn full" type="submit">ÙˆØ±ÙˆØ¯</button>
          <div id="loginMsg" class="msg"></div>
        </form>

        <form id="signupForm" class="form">
          <div class="fg">
            <label for="signupUsername">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
            <input id="signupUsername" class="input" required autocomplete="username" />
          </div>
          <div class="fg">
            <label for="signupPassword">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø­Ø¯Ø§Ù‚Ù„ 6)</label>
            <input id="signupPassword" type="password" minlength="6" class="input" required autocomplete="new-password" />
          </div>
          <button class="btn full" type="submit">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
          <div id="signupMsg" class="msg"></div>
        </form>
      </div>
    </section>

    <!-- Chat -->
    <section id="chatSection" class="chat-wrap hidden">
      <aside class="sidebar">
        <div class="side-top">
          <div class="me">
            <div>
              <div id="meName" class="me-name">Ú©Ø§Ø±Ø¨Ø±</div>
              <div class="me-sub">Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
            </div>
            <button id="logoutBtn" class="btn secondary" type="button">Ø®Ø±ÙˆØ¬</button>
          </div>

          <div class="actions">
            <button id="createGroupBtn" class="btn secondary" type="button">â• Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯</button>
            <button id="joinGroupBtn" class="btn secondary" type="button">ğŸ”— Ù¾ÛŒÙˆØ³ØªÙ†</button>
            <button id="openAiBtn" class="btn" type="button">ğŸ¤– Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</button>
            <button id="copySourceBtn" class="btn secondary" type="button">ğŸ“‹ Ú©Ù¾ÛŒ Ú©Ù„ Ú©Ø¯</button>
          </div>
        </div>

        <div id="groupsList" class="groups"></div>
      </aside>

      <main class="main">
        <div class="header">
          <strong id="roomTitle">Ú¯Ø±ÙˆÙ‡ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</strong>
          <small style="color: var(--sub);">Realtime Firebase</small>
        </div>

        <div id="messages" class="messages">
          <div style="color:var(--sub)">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÛŒÚ© Ú¯Ø±ÙˆÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>
        </div>

        <div class="composer">
          <textarea id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
          <button id="sendBtn" class="btn" type="button">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
      </main>
    </section>
  </div>

  <!-- AI Modal -->
  <div id="aiModal" class="modal">
    <div class="modal-card">
      <div class="modal-head">
        <strong>ğŸ¤– Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</strong>
        <button id="closeAiBtn" class="btn secondary" type="button">Ø¨Ø³ØªÙ†</button>
      </div>

      <div class="fg">
        <label for="apiKeyInput">Gemini API Key</label>
        <input id="apiKeyInput" class="input" type="password" placeholder="AIza..." />
      </div>

      <div id="aiList" class="ai-list"></div>

      <div class="row">
        <textarea id="aiInput" placeholder="Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
        <button id="askAiBtn" class="btn" type="button">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ AI</button>
      </div>
    </div>
  </div>

  <!-- Floating copy button -->
  <button id="globalCopyBtn" class="copy-fab" type="button">ğŸ“‹ Ú©Ù¾ÛŒ Ú©Ù„ Ø³ÙˆØ±Ø³</button>

  <script>
    // =========================
    // Firebase Config
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyAAcLK4sFnrpx8tlltEBRoTV_-VYMndrGQ",
      authDomain: "nova-chat-f73f0.firebaseapp.com",
      databaseURL: "https://nova-chat-f73f0-default-rtdb.firebaseio.com",
      projectId: "nova-chat-f73f0",
      storageBucket: "nova-chat-f73f0.firebasestorage.app",
      messagingSenderId: "1067975852327",
      appId: "1:1067975852327:web:97d3f998e8f0570dd4a902"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    auth.setPersistence(firebase.auth.Auth.Persistence.NONE);

    // =========================
    // State
    // =========================
    const GEMINI_MODEL = "gemini-1.5-flash";
    const GEMINI_KEY_STORAGE = "amirtaha_gemini_key_v1";
    const DEFAULT_GEMINI_KEY = "AIzaSyBqw0Z5kxfndIZ9EtFJ2bKDPbD1ZKKUQOo";
    let currentUser = null;
    let currentGroupId = null;
    let groupsRef = null;
    let messagesRef = null;
    let aiBusy = false;

    // =========================
    // Utils
    // =========================
    const $ = (id) => document.getElementById(id);
    function showMsg(id, text, isError = false) {
      const el = $(id);
      el.textContent = text;
      el.className = "msg " + (isError ? "error" : "ok");
    }
    function clearMsg(id) { $(id).textContent = ""; $(id).className = "msg"; }
    function escapeHtml(s) {
      const d = document.createElement("div");
      d.textContent = s;
      return d.innerHTML;
    }
    function usernameToEmail(username) {
      return username.trim().replace(/\s+/g, "_").toLowerCase() + "@amirtaha.chat";
    }
    function emailToUsername(email) {
      return String(email || "").replace("@amirtaha.chat", "");
    }
    function formatTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      return d.getHours().toString().padStart(2, "0") + ":" + d.getMinutes().toString().padStart(2, "0");
    }

    // =========================
    // Tabs
    // =========================
    function setTab(tab) {
      $("tabLogin").classList.toggle("active", tab === "login");
      $("tabSignup").classList.toggle("active", tab === "signup");
      $("loginForm").classList.toggle("active", tab === "login");
      $("signupForm").classList.toggle("active", tab === "signup");
      clearMsg("loginMsg");
      clearMsg("signupMsg");
    }
    $("tabLogin").addEventListener("click", () => setTab("login"));
    $("tabSignup").addEventListener("click", () => setTab("signup"));

    // =========================
    // Auth
    // =========================
    $("signupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMsg("signupMsg");
      const username = $("signupUsername").value.trim();
      const password = $("signupPassword").value;

      if (!username || !password) return showMsg("signupMsg", "ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª", true);
      if (password.length < 6) return showMsg("signupMsg", "Ø±Ù…Ø² Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 6 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯", true);

      const email = usernameToEmail(username);

      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        await database.ref("users/" + cred.user.uid).set({
          username,
          email,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        showMsg("signupMsg", "Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ âœ…");
        setTimeout(() => {
          currentUser = cred.user;
          onLogin();
        }, 500);
      } catch (err) {
        console.error(err);
        showMsg("signupMsg", "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: " + (err.code || "unknown"), true);
      }
    });

    $("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMsg("loginMsg");
      const username = $("loginUsername").value.trim();
      const password = $("loginPassword").value;
      if (!username || !password) return showMsg("loginMsg", "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯", true);

      try {
        const email = usernameToEmail(username);
        const cred = await auth.signInWithEmailAndPassword(email, password);
        currentUser = cred.user;
        onLogin();
      } catch (err) {
        console.error(err);
        showMsg("loginMsg", "ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚: " + (err.code || "unknown"), true);
      }
    });

    function onLogin() {
      $("authSection").classList.add("hidden");
      $("chatSection").classList.remove("hidden");
      loadUserProfile();
      bindGroups();
    }

    $("logoutBtn").addEventListener("click", async () => {
      if (!confirm("Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ØŸ")) return;
      try {
        if (groupsRef) groupsRef.off();
        if (messagesRef) messagesRef.off();
        await auth.signOut();
      } catch (e) {
        console.error(e);
      } finally {
        currentUser = null;
        currentGroupId = null;
        $("chatSection").classList.add("hidden");
        $("authSection").classList.remove("hidden");
        $("roomTitle").textContent = "Ú¯Ø±ÙˆÙ‡ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡";
        $("groupsList").innerHTML = "";
        $("messages").innerHTML = '<div style="color:var(--sub)">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÛŒÚ© Ú¯Ø±ÙˆÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>';
      }
    });

    async function loadUserProfile() {
      try {
        const snap = await database.ref("users/" + currentUser.uid).once("value");
        const data = snap.val() || {};
        $("meName").textContent = data.username || emailToUsername(currentUser.email);
      } catch {
        $("meName").textContent = emailToUsername(currentUser.email);
      }
    }

    // =========================
    // Groups
    // =========================
    $("createGroupBtn").addEventListener("click", async () => {
      const name = prompt("Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯:");
      if (!name || !name.trim()) return;
      const password = prompt("Ø±Ù…Ø² Ú¯Ø±ÙˆÙ‡ (Ø­Ø¯Ø§Ù‚Ù„ 6 Ú©Ø§Ø±Ø§Ú©ØªØ±):", "");
      if (!password || password.length < 6) return alert("Ø±Ù…Ø² Ú©ÙˆØªØ§Ù‡ Ø§Ø³Øª");

      try {
        const groupRef = database.ref("groups").push();
        const groupId = groupRef.key;
        await groupRef.set({
          name: name.trim(),
          password,
          owner: currentUser.uid,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        await database.ref("groupMembers/" + groupId + "/" + currentUser.uid).set(true);
        await database.ref("userGroups/" + currentUser.uid + "/" + groupId).set(true);
        selectGroup(groupId);
      } catch (err) {
        console.error(err);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡");
      }
    });

    $("joinGroupBtn").addEventListener("click", async () => {
      try {
        const allSnap = await database.ref("groups").once("value");
        const allGroups = allSnap.val() || {};
        const mySnap = await database.ref("userGroups/" + currentUser.uid).once("value");
        const myGroups = mySnap.val() || {};

        const available = Object.entries(allGroups).filter(([id]) => !myGroups[id]);
        if (!available.length) return alert("Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÙˆØ³ØªÙ† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯");

        const text = available.map(([id, g], i) => `${i + 1}) ${g.name}`).join("\n");
        const pick = prompt("Ø´Ù…Ø§Ø±Ù‡ Ú¯Ø±ÙˆÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n" + text, "");
        const idx = Number(pick) - 1;
        if (Number.isNaN(idx) || idx < 0 || idx >= available.length) return;

        const [groupId, groupData] = available[idx];
        const pass = prompt("Ø±Ù…Ø² Ú¯Ø±ÙˆÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", "");
        if (pass !== groupData.password) return alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");

        await database.ref("groupMembers/" + groupId + "/" + currentUser.uid).set(true);
        await database.ref("userGroups/" + currentUser.uid + "/" + groupId).set(true);
        selectGroup(groupId);
      } catch (err) {
        console.error(err);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒÙˆØ³ØªÙ†");
      }
    });

    function bindGroups() {
      if (!currentUser) return;
      if (groupsRef) groupsRef.off();

      groupsRef = database.ref("userGroups/" + currentUser.uid);
      groupsRef.on("value", async (snapshot) => {
        const groupMap = snapshot.val() || {};
        const ids = Object.keys(groupMap);

        if (!ids.length) {
          $("groupsList").innerHTML = '<div style="color:var(--sub)">Ù‡Ù†ÙˆØ² Ú¯Ø±ÙˆÙ‡ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</div>';
          return;
        }

        const groupsSnap = await database.ref("groups").once("value");
        const allGroups = groupsSnap.val() || {};
        const listHtml = [];

        ids.forEach((groupId) => {
          const g = allGroups[groupId];
          if (!g) return;
          const active = currentGroupId === groupId ? "active" : "";
          const ownerText = g.owner === currentUser.uid ? "Ù…Ø§Ù„Ú©" : "Ø¹Ø¶Ùˆ";
          listHtml.push(`
            <div class="group ${active}" data-group-id="${groupId}">
              <strong>${escapeHtml(g.name || "Ú¯Ø±ÙˆÙ‡")}</strong><br />
              <small>${ownerText}</small>
            </div>
          `);
        });

        $("groupsList").innerHTML = listHtml.join("");
        document.querySelectorAll(".group").forEach((el) => {
          el.addEventListener("click", () => selectGroup(el.dataset.groupId));
        });

        if (!currentGroupId && ids.length) selectGroup(ids[0]);
      });
    }

    async function selectGroup(groupId) {
      if (!groupId || currentGroupId === groupId) return;
      currentGroupId = groupId;

      document.querySelectorAll(".group").forEach((el) => {
        el.classList.toggle("active", el.dataset.groupId === groupId);
      });

      const groupSnap = await database.ref("groups/" + groupId).once("value");
      const group = groupSnap.val() || {};
      $("roomTitle").textContent = group.name || "Ú¯Ø±ÙˆÙ‡";

      bindMessages(groupId);
    }

    // =========================
    // Messages
    // =========================
    function bindMessages(groupId) {
      if (messagesRef) messagesRef.off();
      $("messages").innerHTML = '<div style="color:var(--sub)">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';

      messagesRef = database.ref("messages/" + groupId).orderByChild("timestamp");
      messagesRef.on("value", (snapshot) => {
        const raw = snapshot.val() || {};
        const arr = Object.entries(raw)
          .map(([id, msg]) => ({ id, ...msg }))
          .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

        if (!arr.length) {
          $("messages").innerHTML = '<div style="color:var(--sub)">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
          return;
        }

        $("messages").innerHTML = arr.map((m) => {
          const isMe = m.userId === currentUser.uid;
          const cls = isMe ? "bubble me" : "bubble";
          const username = m.userData?.username || "Ú©Ø§Ø±Ø¨Ø±";
          return `
            <div class="${cls}">
              <div class="meta">${escapeHtml(isMe ? "Ø´Ù…Ø§" : username)} â€¢ ${formatTime(m.timestamp)}</div>
              <div>${escapeHtml(m.text || "")}</div>
            </div>
          `;
        }).join("");

        $("messages").scrollTop = $("messages").scrollHeight;
      });
    }

    async function sendMessage() {
      if (!currentGroupId) return alert("Ø§ÙˆÙ„ Ú¯Ø±ÙˆÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
      const text = $("messageInput").value.trim();
      if (!text) return;

      $("sendBtn").disabled = true;
      try {
        const snap = await database.ref("users/" + currentUser.uid).once("value");
        const data = snap.val() || {};
        const username = data.username || emailToUsername(currentUser.email);

        await database.ref("messages/" + currentGroupId).push().set({
          text,
          userId: currentUser.uid,
          userData: { username },
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        $("messageInput").value = "";
        $("messageInput").style.height = "50px";
      } catch (e) {
        console.error(e);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…");
      } finally {
        $("sendBtn").disabled = false;
      }
    }

    $("sendBtn").addEventListener("click", sendMessage);
    $("messageInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    $("messageInput").addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = Math.min(this.scrollHeight, 150) + "px";
    });

    // =========================
    // AI
    // =========================
    function aiAppend(text, type = "bot") {
      const div = document.createElement("div");
      div.className = "ai-msg " + (type === "user" ? "user" : type === "note" ? "note" : "bot");
      div.textContent = text;
      $("aiList").appendChild(div);
      $("aiList").scrollTop = $("aiList").scrollHeight;
    }

    function openAi() {
      $("aiModal").classList.add("show");
      $("aiList").innerHTML = "";
      const saved = localStorage.getItem(GEMINI_KEY_STORAGE) || DEFAULT_GEMINI_KEY;
      $("apiKeyInput").value = saved;
      aiAppend("Ø³Ù„Ø§Ù…! Ø³ÙˆØ§Ù„Øª Ø±Ùˆ Ø¨Ù¾Ø±Ø³ ğŸŒŸ", "note");
    }
    function closeAi() { $("aiModal").classList.remove("show"); }

    $("openAiBtn").addEventListener("click", openAi);
    $("closeAiBtn").addEventListener("click", closeAi);
    $("aiModal").addEventListener("click", (e) => {
      if (e.target === $("aiModal")) closeAi();
    });

    async function askAI() {
      if (aiBusy) return;
      const text = $("aiInput").value.trim();
      if (!text) return;

      const key = $("apiKeyInput").value.trim();
      if (!key) return alert("API Key Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");

      localStorage.setItem(GEMINI_KEY_STORAGE, key);
      aiAppend(text, "user");
      $("aiInput").value = "";

      aiBusy = true;
      $("askAiBtn").disabled = true;
      $("askAiBtn").textContent = "...";

      try {
        let context = "Ú¯Ø±ÙˆÙ‡ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡.";
        if (currentGroupId) {
          const snap = await database.ref("messages/" + currentGroupId).once("value");
          const raw = snap.val() || {};
          const arr = Object.values(raw).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0)).slice(-12);
          context = arr.map((m) => `${m.userData?.username || "Ú©Ø§Ø±Ø¨Ø±"}: ${m.text || ""}`).join("\n") || "Ø¨Ø¯ÙˆÙ† Ú©Ø§Ù†ØªÚ©Ø³Øª";
        }

        const prompt = `
ØªÙˆ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± ÙØ§Ø±Ø³ÛŒ Ù‡Ø³ØªÛŒ. Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ú©ÙˆØªØ§Ù‡ØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø¨Ø§Ø´Ù†Ø¯.

Ú©Ø§Ù†ØªÚ©Ø³Øª Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡:
${context}

Ø³ÙˆØ§Ù„ Ú©Ø§Ø±Ø¨Ø±:
${text}
        `.trim();

        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${encodeURIComponent(key)}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ role: "user", parts: [{ text: prompt }] }],
              generationConfig: {
                temperature: 0.7,
                topK: 32,
                topP: 0.95,
                maxOutputTokens: 1024
              }
            })
          }
        );

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || "AI request failed");
        }

        const data = await res.json();
        const output =
          data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() ||
          "Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.";
        aiAppend(output, "bot");
      } catch (err) {
        console.error(err);
        aiAppend("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ. API Key ÛŒØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.", "note");
      } finally {
        aiBusy = false;
        $("askAiBtn").disabled = false;
        $("askAiBtn").textContent = "Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ AI";
      }
    }

    $("askAiBtn").addEventListener("click", askAI);
    $("aiInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        askAI();
      }
    });

    // =========================
    // Copy full source
    // =========================
    async function copyFullSource() {
      const src = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
      try {
        await navigator.clipboard.writeText(src);
        alert("Ú©Ù„ Ú©Ø¯ ØµÙØ­Ù‡ Ú©Ù¾ÛŒ Ø´Ø¯ âœ…");
      } catch (e) {
        console.error(e);
        alert("Ú©Ù¾ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯. Ø§Ø¬Ø§Ø²Ù‡ Clipboard Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.");
      }
    }
    $("copySourceBtn").addEventListener("click", copyFullSource);
    $("globalCopyBtn").addEventListener("click", copyFullSource);

    // =========================
    // Boot
    // =========================
    auth.onAuthStateChanged(async (user) => {
      if (!user) return;
      currentUser = user;
      $("authSection").classList.add("hidden");
      $("chatSection").classList.remove("hidden");
      await loadUserProfile();
      bindGroups();
    });

    setTab("login");
    console.log("âœ… Amirtaha Chat + AI Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª");
  </script>
</body>
</html>
