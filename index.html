<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø±ÙˆÙ… Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</title>
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #48bb78;
            --danger-color: #f56565;
            --dark-bg: #1a202c;
            --light-bg: #2d3748;
            --lighter-bg: #4a5568;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --ai-color: #10b981;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            background: var(--dark-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            height: 90vh;
        }

        /* Auth Screens */
        .auth-container {
            width: 100%;
            max-width: 400px;
            background: var(--dark-bg);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: var(--text-primary);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            background: var(--light-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
        }

        .auth-switch a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--light-bg);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }

        .sidebar-header {
            padding: 20px;
            background: var(--lighter-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
            object-fit: cover;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-details h3 {
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 4px;
        }

        .user-details p {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .sidebar-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            background: var(--dark-bg);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: var(--primary-color);
        }

        .ai-assistant-btn {
            background: linear-gradient(135deg, var(--ai-color), #059669);
        }

        .ai-assistant-btn:hover {
            background: linear-gradient(135deg, #059669, var(--ai-color));
        }

        .groups-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .group-item {
            padding: 15px;
            background: var(--dark-bg);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .group-item:hover {
            background: var(--lighter-bg);
        }

        .group-item.active {
            background: var(--primary-color);
        }

        .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success-color), #38a169);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            object-fit: cover;
        }

        .group-info {
            flex: 1;
        }

        .group-info h4 {
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .group-info p {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
        }

        .chat-header {
            padding: 20px;
            background: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-info h3 {
            color: var(--text-primary);
            font-size: 18px;
        }

        .chat-header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 8px 15px;
            background: var(--dark-bg);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: var(--primary-color);
        }

        .header-btn.danger:hover {
            background: var(--danger-color);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
            object-fit: cover;
        }

        .message-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-header strong {
            color: var(--text-primary);
            font-size: 14px;
        }

        .message-header span {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .message-text {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            background: var(--light-bg);
            padding: 10px 15px;
            border-radius: 10px;
            word-wrap: break-word;
        }

        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .message-actions button {
            padding: 4px 10px;
            background: var(--lighter-bg);
            border: none;
            border-radius: 5px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .message-actions button:hover {
            background: var(--danger-color);
            color: white;
        }

        .message.ai {
            background: rgba(16, 185, 129, 0.05);
            padding: 15px;
            border-radius: 15px;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, var(--ai-color), #059669);
        }

        .message.ai .message-header strong {
            color: var(--ai-color);
        }

        .input-area {
            padding: 20px;
            background: var(--light-bg);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            background: var(--dark-bg);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            max-height: 100px;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .emoji-btn, .send-btn {
            width: 45px;
            height: 45px;
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-btn:hover, .send-btn:hover {
            transform: scale(1.1);
        }

        /* Emoji Panel */
        .emoji-panel {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 15px;
            display: none;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .emoji-panel.active {
            display: block;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-item {
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            text-align: center;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .emoji-item:hover {
            background: var(--lighter-bg);
            transform: scale(1.2);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--light-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--text-primary);
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        /* AI Chat Modal */
        .ai-chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .ai-chat-modal.active {
            display: flex;
        }

        .ai-chat-content {
            background: var(--light-bg);
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-chat-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--ai-color), #059669);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ai-chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .ai-chat-title {
            flex: 1;
        }

        .ai-chat-title h3 {
            color: white;
            font-size: 20px;
            margin-bottom: 4px;
        }

        .ai-chat-title p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
        }

        .ai-chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .ai-chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .ai-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: var(--dark-bg);
        }

        .ai-input-area {
            padding: 20px;
            background: var(--light-bg);
            border-top: 1px solid var(--border-color);
        }

        .ai-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .ai-message-input {
            flex: 1;
            padding: 12px 15px;
            background: var(--dark-bg);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            max-height: 100px;
            font-family: inherit;
        }

        .ai-message-input:focus {
            outline: none;
            border-color: var(--ai-color);
        }

        .ai-send-btn {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--ai-color), #059669);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-send-btn:hover {
            transform: scale(1.1);
        }

        .ai-thinking {
            display: none;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 10px;
            align-items: center;
            gap: 10px;
        }

        .ai-thinking.active {
            display: flex;
        }

        .ai-thinking-dots {
            display: flex;
            gap: 5px;
        }

        .ai-thinking-dots span {
            width: 8px;
            height: 8px;
            background: var(--ai-color);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .ai-thinking-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .ai-thinking-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Avatar Preview */
        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 60px;
            font-weight: 600;
            object-fit: cover;
        }

        .avatar-upload {
            margin-bottom: 20px;
        }

        .avatar-upload input[type="file"] {
            display: none;
        }

        .avatar-upload label {
            display: block;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .avatar-upload label:hover {
            background: var(--secondary-color);
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--text-secondary);
            text-align: center;
            padding: 40px;
        }

        .welcome-screen h2 {
            color: var(--text-primary);
            font-size: 32px;
            margin-bottom: 15px;
        }

        .welcome-screen p {
            font-size: 16px;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
            }

            .sidebar {
                width: 100%;
                max-height: 40vh;
                border-left: none;
                border-bottom: 1px solid var(--border-color);
            }

            .chat-area {
                height: 60vh;
            }

            .emoji-panel {
                bottom: 70px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--lighter-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Error Message */
        .error-message {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
            text-align: center;
        }

        .success-message {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="auth-container" id="loginScreen">
        <div class="auth-header">
            <h2>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ğŸ‘‹</h2>
            <p>Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯</p>
        </div>
        <div id="loginError"></div>
        <form id="loginForm">
            <div class="input-group">
                <label>Ø§ÛŒÙ…ÛŒÙ„</label>
                <input type="email" id="loginEmail" required placeholder="example@email.com">
            </div>
            <div class="input-group">
                <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                <input type="password" id="loginPassword" required placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
            </div>
            <button type="submit" class="btn">ÙˆØ±ÙˆØ¯</button>
        </form>
        <div class="auth-switch">
            Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ <a id="showSignup">Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯</a>
        </div>
    </div>

    <!-- Signup Screen -->
    <div class="auth-container hidden" id="signupScreen">
        <div class="auth-header">
            <h2>Ø«Ø¨Øª Ù†Ø§Ù… ğŸ‰</h2>
            <p>Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯</p>
        </div>
        <div id="signupError"></div>
        <form id="signupForm">
            <div class="input-group">
                <label>Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label>
                <input type="text" id="signupDisplayName" required placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
            </div>
            <div class="input-group">
                <label>Ø§ÛŒÙ…ÛŒÙ„</label>
                <input type="email" id="signupEmail" required placeholder="example@email.com">
            </div>
            <div class="input-group">
                <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                <input type="password" id="signupPassword" required placeholder="Ø­Ø¯Ø§Ù‚Ù„ 6 Ú©Ø§Ø±Ø§Ú©ØªØ±">
            </div>
            <button type="submit" class="btn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
        </form>
        <div class="auth-switch">
            Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ <a id="showLogin">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>
        </div>
    </div>

    <!-- Main App -->
    <div class="container hidden" id="mainApp">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <img class="user-avatar" id="userAvatar" src="" alt="User" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="user-avatar" id="userAvatarFallback" style="display: none;">U</div>
                    <div class="user-details">
                        <h3 id="userName">Ú©Ø§Ø±Ø¨Ø±</h3>
                        <p id="userEmail">user@email.com</p>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <button class="action-btn" id="createGroupBtn">Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡</button>
                    <button class="action-btn" id="joinGroupBtn">Ù¾ÛŒÙˆØ³ØªÙ†</button>
                    <button class="action-btn ai-assistant-btn" id="aiAssistantBtn">ğŸ¤– AI</button>
                    <button class="action-btn" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
            <div class="groups-container" id="groupsContainer">
                <!-- Groups will be loaded here -->
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="welcome-screen" id="welcomeScreen">
                <h2>Ø¨Ù‡ Ú†Øª Ø±ÙˆÙ… Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! ğŸ‰</h2>
                <p>ÛŒÚ© Ú¯Ø±ÙˆÙ‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ÛŒ Ø¨Ù¾ÛŒÙˆÙ†Ø¯ÛŒØ¯</p>
                <p>Ù‡Ù…Ú†Ù†ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ú¯ÙØªÚ¯Ùˆ Ú©Ù†ÛŒØ¯ ğŸ¤–</p>
            </div>

            <div class="hidden" id="chatScreen">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <img class="group-avatar" id="currentGroupAvatar" src="" alt="Group" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="group-avatar" id="currentGroupAvatarFallback" style="display: none;">G</div>
                        <h3 id="currentGroupName">Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡</h3>
                    </div>
                    <div class="chat-header-actions">
                        <button class="header-btn" id="groupInfoBtn">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú¯Ø±ÙˆÙ‡</button>
                        <button class="header-btn" id="leaveGroupBtn">Ø®Ø±ÙˆØ¬ Ø§Ø² Ú¯Ø±ÙˆÙ‡</button>
                        <button class="header-btn danger" id="deleteGroupBtn">Ø­Ø°Ù Ú¯Ø±ÙˆÙ‡</button>
                    </div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>

                <div class="emoji-panel" id="emojiPanel">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>

                <div class="input-area">
                    <div class="input-wrapper">
                        <button class="emoji-btn" id="emojiBtn">ğŸ˜Š</button>
                        <textarea class="message-input" id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." rows="1"></textarea>
                        <button class="send-btn" id="sendBtn">â¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div class="ai-chat-modal" id="aiChatModal">
        <div class="ai-chat-content">
            <div class="ai-chat-header">
                <div class="ai-chat-avatar">ğŸ¤–</div>
                <div class="ai-chat-title">
                    <h3>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</h3>
                    <p>Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ø´Ù…Ø§ Ø¨Ø§ Gemini AI</p>
                </div>
                <button class="ai-chat-close" id="aiChatClose">Ã—</button>
            </div>
            <div class="ai-messages-container" id="aiMessagesContainer">
                <div class="message ai">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <div class="message-header">
                            <strong>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</strong>
                        </div>
                        <div class="message-text">
                            Ø³Ù„Ø§Ù…! ğŸ‘‹ Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø´Ù…Ø§ Ù‡Ø³ØªÙ…. Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©ØªÙˆÙ† Ú©Ù†Ù…ØŸ
                        </div>
                    </div>
                </div>
            </div>
            <div class="ai-thinking" id="aiThinking">
                <div class="ai-thinking-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span style="color: var(--text-secondary); font-size: 14px;">Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†...</span>
            </div>
            <div class="ai-input-area">
                <div class="ai-input-wrapper">
                    <textarea class="ai-message-input" id="aiMessageInput" placeholder="Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯..." rows="1"></textarea>
                    <button class="ai-send-btn" id="aiSendBtn">â¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯</h3>
                <button class="close-btn" id="closeCreateGroup">Ã—</button>
            </div>
            <div id="createGroupError"></div>
            <form id="createGroupForm">
                <div class="input-group">
                    <label>Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡</label>
                    <input type="text" id="groupName" required placeholder="Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                </div>
                <div class="avatar-upload">
                    <label for="groupAvatarInput">Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ Ú¯Ø±ÙˆÙ‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <input type="file" id="groupAvatarInput" accept="image/*">
                </div>
                <div class="avatar-preview" id="groupAvatarPreview">G</div>
                <button type="submit" class="btn">Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡</button>
            </form>
        </div>
    </div>

    <!-- Join Group Modal -->
    <div class="modal" id="joinGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡</h3>
                <button class="close-btn" id="closeJoinGroup">Ã—</button>
            </div>
            <div id="joinGroupError"></div>
            <form id="joinGroupForm">
                <div class="input-group">
                    <label>Ú©Ø¯ Ú¯Ø±ÙˆÙ‡</label>
                    <input type="text" id="groupCode" required placeholder="Ú©Ø¯ Ú¯Ø±ÙˆÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                </div>
                <button type="submit" class="btn">Ù¾ÛŒÙˆØ³ØªÙ†</button>
            </form>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal" id="userProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
                <button class="close-btn" id="closeUserProfile">Ã—</button>
            </div>
            <div class="avatar-upload">
                <label for="userAvatarInput">ØªØºÛŒÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</label>
                <input type="file" id="userAvatarInput" accept="image/*">
            </div>
            <img class="avatar-preview" id="userAvatarPreview" src="" alt="User Avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="avatar-preview" id="userAvatarPreviewFallback" style="display: none;">U</div>
            <div class="input-group">
                <label>Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label>
                <input type="text" id="editDisplayName" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¬Ø¯ÛŒØ¯">
            </div>
            <button class="btn" id="saveProfileBtn">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
        </div>
    </div>

    <!-- Group Info Modal -->
    <div class="modal" id="groupInfoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú¯Ø±ÙˆÙ‡</h3>
                <button class="close-btn" id="closeGroupInfo">Ã—</button>
            </div>
            <div class="avatar-upload">
                <label for="editGroupAvatarInput">ØªØºÛŒÛŒØ± Ø¹Ú©Ø³ Ú¯Ø±ÙˆÙ‡</label>
                <input type="file" id="editGroupAvatarInput" accept="image/*">
            </div>
            <img class="avatar-preview" id="editGroupAvatarPreview" src="" alt="Group Avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="avatar-preview" id="editGroupAvatarPreviewFallback" style="display: none;">G</div>
            <div class="input-group">
                <label>Ú©Ø¯ Ú¯Ø±ÙˆÙ‡</label>
                <input type="text" id="groupCodeDisplay" readonly>
                <button class="btn" id="copyGroupCodeBtn" style="margin-top: 10px;">Ú©Ù¾ÛŒ Ú©Ø¯ Ú¯Ø±ÙˆÙ‡</button>
            </div>
            <div class="input-group">
                <label>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¶Ø§: <span id="memberCount">0</span></label>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, push, onValue, remove, get, update, onChildAdded, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { GoogleGenerativeAI } from '@google/generative-ai';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjJeo30i7vZ_b4kWYgQfm2T6WGLMiJJXM",
            authDomain: "chat-app-6c2e3.firebaseapp.com",
            databaseURL: "https://chat-app-6c2e3-default-rtdb.firebaseio.com",
            projectId: "chat-app-6c2e3",
            storageBucket: "chat-app-6c2e3.appspot.com",
            messagingSenderId: "891260292290",
            appId: "1:891260292290:web:4f8e7d3b2c1a5f6g8h9i0j"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Gemini AI Configuration
        const GEMINI_API_KEY = 'AIzaSyAkH9Zg7GShfrVuNfymLswjejT0qLKqXXI';
        const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        const aiModel = genAI.getGenerativeModel({ model: 'gemini-pro' });
        let aiChatHistory = [];

        // Global Variables
        let currentUser = null;
        let currentGroupId = null;
        let userGroups = [];

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const signupScreen = document.getElementById('signupScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const showSignup = document.getElementById('showSignup');
        const showLogin = document.getElementById('showLogin');
        const logoutBtn = document.getElementById('logoutBtn');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const joinGroupBtn = document.getElementById('joinGroupBtn');
        const aiAssistantBtn = document.getElementById('aiAssistantBtn');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const chatScreen = document.getElementById('chatScreen');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiGrid = document.getElementById('emojiGrid');
        const groupsContainer = document.getElementById('groupsContainer');
        const userAvatar = document.getElementById('userAvatar');
        const userAvatarFallback = document.getElementById('userAvatarFallback');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const currentGroupName = document.getElementById('currentGroupName');
        const currentGroupAvatar = document.getElementById('currentGroupAvatar');
        const currentGroupAvatarFallback = document.getElementById('currentGroupAvatarFallback');
        const createGroupModal = document.getElementById('createGroupModal');
        const joinGroupModal = document.getElementById('joinGroupModal');
        const userProfileModal = document.getElementById('userProfileModal');
        const groupInfoModal = document.getElementById('groupInfoModal');
        const aiChatModal = document.getElementById('aiChatModal');
        const aiMessagesContainer = document.getElementById('aiMessagesContainer');
        const aiMessageInput = document.getElementById('aiMessageInput');
        const aiSendBtn = document.getElementById('aiSendBtn');
        const aiChatClose = document.getElementById('aiChatClose');
        const aiThinking = document.getElementById('aiThinking');

        // Emojis
        const emojis = ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','ğŸ˜š','ğŸ˜™','ğŸ¥²','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ¥¸','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾'];

        // Initialize Emojis
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.textContent = emoji;
            span.onclick = () => {
                messageInput.value += emoji;
                emojiPanel.classList.remove('active');
                messageInput.focus();
            };
            emojiGrid.appendChild(span);
        });

        // Toggle Emoji Panel
        emojiBtn.addEventListener('click', () => {
            emojiPanel.classList.toggle('active');
        });

        // Close emoji panel when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                emojiPanel.classList.remove('active');
            }
        });

        // Auth State Observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showMainApp();
                loadUserData();
                loadUserGroups();
            } else {
                currentUser = null;
                showLoginScreen();
            }
        });

        // Show Screens
        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            signupScreen.classList.add('hidden');
            mainApp.classList.add('hidden');
        }

        function showSignupScreen() {
            loginScreen.classList.add('hidden');
            signupScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
        }

        function showMainApp() {
            loginScreen.classList.add('hidden');
            signupScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
        }

        // Auth Switching
        showSignup.addEventListener('click', showSignupScreen);
        showLogin.addEventListener('click', showLoginScreen);

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                errorDiv.innerHTML = '';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">Ø®Ø·Ø§: ${getErrorMessage(error.code)}</div>`;
            }
        });

        // Signup
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const displayName = document.getElementById('signupDisplayName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const errorDiv = document.getElementById('signupError');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName });
                await set(ref(db, `users/${userCredential.user.uid}`), {
                    displayName,
                    email,
                    avatar: '',
                    createdAt: Date.now()
                });
                errorDiv.innerHTML = '';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">Ø®Ø·Ø§: ${getErrorMessage(error.code)}</div>`;
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            currentGroupId = null;
            userGroups = [];
            aiChatHistory = [];
            welcomeScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
        });

        // Load User Data
        async function loadUserData() {
            const userRef = ref(db, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            if (userData) {
                userName.textContent = userData.displayName || currentUser.displayName || 'Ú©Ø§Ø±Ø¨Ø±';
                userEmail.textContent = userData.email || currentUser.email;
                
                if (userData.avatar) {
                    userAvatar.src = userData.avatar;
                    userAvatar.style.display = 'block';
                    userAvatarFallback.style.display = 'none';
                } else {
                    userAvatar.style.display = 'none';
                    userAvatarFallback.style.display = 'flex';
                    userAvatarFallback.textContent = (userData.displayName || 'U').charAt(0).toUpperCase();
                }
            }
        }

        // Load User Groups
        function loadUserGroups() {
            const userGroupsRef = ref(db, `userGroups/${currentUser.uid}`);
            onValue(userGroupsRef, async (snapshot) => {
                groupsContainer.innerHTML = '';
                userGroups = [];

                if (snapshot.exists()) {
                    const groupIds = Object.keys(snapshot.val());
                    
                    for (const groupId of groupIds) {
                        const groupRef = ref(db, `groups/${groupId}`);
                        const groupSnapshot = await get(groupRef);
                        
                        if (groupSnapshot.exists()) {
                            const groupData = groupSnapshot.val();
                            userGroups.push({ id: groupId, ...groupData });
                            displayGroup(groupId, groupData);
                        }
                    }
                } else {
                    groupsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Ù‡Ù†ÙˆØ² Ø¹Ø¶Ùˆ Ù‡ÛŒÚ† Ú¯Ø±ÙˆÙ‡ÛŒ Ù†ÛŒØ³ØªÛŒØ¯</p>';
                }
            });
        }

        // Display Group
        function displayGroup(groupId, groupData) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group-item';
            if (currentGroupId === groupId) groupDiv.classList.add('active');
            
            const avatarHtml = groupData.avatar 
                ? `<img src="${groupData.avatar}" class="group-avatar" alt="Group">` 
                : `<div class="group-avatar">${groupData.name.charAt(0).toUpperCase()}</div>`;
            
            groupDiv.innerHTML = `
                ${avatarHtml}
                <div class="group-info">
                    <h4>${groupData.name}</h4>
                    <p>Ú©Ø¯: ${groupData.code}</p>
                </div>
            `;
            
            groupDiv.addEventListener('click', () => loadGroup(groupId, groupData));
            groupsContainer.appendChild(groupDiv);
        }

        // Load Group
        function loadGroup(groupId, groupData) {
            currentGroupId = groupId;
            currentGroupName.textContent = groupData.name;
            
            if (groupData.avatar) {
                currentGroupAvatar.src = groupData.avatar;
                currentGroupAvatar.style.display = 'block';
                currentGroupAvatarFallback.style.display = 'none';
            } else {
                currentGroupAvatar.style.display = 'none';
                currentGroupAvatarFallback.style.display = 'flex';
                currentGroupAvatarFallback.textContent = groupData.name.charAt(0).toUpperCase();
            }
            
            welcomeScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            
            // Update active group
            document.querySelectorAll('.group-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            loadMessages(groupId);
        }

        // Load Messages
        function loadMessages(groupId) {
            messagesContainer.innerHTML = '';
            const messagesRef = ref(db, `messages/${groupId}`);
            
            onValue(messagesRef, (snapshot) => {
                messagesContainer.innerHTML = '';
                if (snapshot.exists()) {
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    messages.forEach(msg => displayMessage(msg));
                }
            });
        }

        // Display Message
        function displayMessage(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const avatarHtml = msg.avatar 
                ? `<img src="${msg.avatar}" class="message-avatar" alt="User">` 
                : `<div class="message-avatar">${msg.senderName.charAt(0).toUpperCase()}</div>`;
            
            const deleteBtn = msg.senderId === currentUser.uid 
                ? `<button onclick="deleteMessage('${msg.id}')">Ø­Ø°Ù</button>` 
                : '';
            
            const time = new Date(msg.timestamp).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                ${avatarHtml}
                <div class="message-content">
                    <div class="message-header">
                        <strong>${msg.senderName}</strong>
                        <span>${time}</span>
                    </div>
                    <div class="message-text">${msg.text}</div>
                    <div class="message-actions">
                        ${deleteBtn}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send Message
        async function sendMessage() {
            if (!currentGroupId || !messageInput.value.trim()) return;
            
            const userRef = ref(db, `users/${currentUser.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();
            
            const messageData = {
                text: messageInput.value.trim(),
                senderId: currentUser.uid,
                senderName: userData?.displayName || currentUser.displayName || 'Ú©Ø§Ø±Ø¨Ø±',
                avatar: userData?.avatar || '',
                timestamp: Date.now()
            };
            
            const messagesRef = ref(db, `messages/${currentGroupId}`);
            await push(messagesRef, messageData);
            
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        // Delete Message
        window.deleteMessage = async function(messageId) {
            if (!currentGroupId) return;
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
                const messageRef = ref(db, `messages/${currentGroupId}/${messageId}`);
                await remove(messageRef);
            }
        };

        // Create Group
        createGroupBtn.addEventListener('click', () => {
            createGroupModal.classList.add('active');
            document.getElementById('groupName').value = '';
            document.getElementById('groupAvatarInput').value = '';
            document.getElementById('groupAvatarPreview').textContent = 'G';
            document.getElementById('groupAvatarPreview').style.backgroundImage = '';
        });

        document.getElementById('closeCreateGroup').addEventListener('click', () => {
            createGroupModal.classList.remove('active');
        });

        document.getElementById('groupAvatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const compressed = await compressImage(file);
                document.getElementById('groupAvatarPreview').style.backgroundImage = `url(${compressed})`;
                document.getElementById('groupAvatarPreview').textContent = '';
            }
        });

        document.getElementById('createGroupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = document.getElementById('groupName').value;
            const avatarInput = document.getElementById('groupAvatarInput');
            const errorDiv = document.getElementById('createGroupError');
            
            try {
                const groupCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const groupRef = push(ref(db, 'groups'));
                const groupId = groupRef.key;
                
                let avatarData = '';
                if (avatarInput.files[0]) {
                    avatarData = await compressImage(avatarInput.files[0]);
                }
                
                const groupData = {
                    name: groupName,
                    code: groupCode,
                    avatar: avatarData,
                    createdBy: currentUser.uid,
                    createdAt: Date.now(),
                    members: { [currentUser.uid]: true }
                };
                
                await set(groupRef, groupData);
                await set(ref(db, `userGroups/${currentUser.uid}/${groupId}`), true);
                
                createGroupModal.classList.remove('active');
                errorDiv.innerHTML = '';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡: ${error.message}</div>`;
            }
        });

        // Join Group
        joinGroupBtn.addEventListener('click', () => {
            joinGroupModal.classList.add('active');
            document.getElementById('groupCode').value = '';
        });

        document.getElementById('closeJoinGroup').addEventListener('click', () => {
            joinGroupModal.classList.remove('active');
        });

        document.getElementById('joinGroupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupCode = document.getElementById('groupCode').value.toUpperCase();
            const errorDiv = document.getElementById('joinGroupError');
            
            try {
                const groupsRef = ref(db, 'groups');
                const snapshot = await get(groupsRef);
                
                let foundGroupId = null;
                snapshot.forEach((childSnapshot) => {
                    if (childSnapshot.val().code === groupCode) {
                        foundGroupId = childSnapshot.key;
                    }
                });
                
                if (foundGroupId) {
                    await set(ref(db, `groups/${foundGroupId}/members/${currentUser.uid}`), true);
                    await set(ref(db, `userGroups/${currentUser.uid}/${foundGroupId}`), true);
                    joinGroupModal.classList.remove('active');
                    errorDiv.innerHTML = '';
                } else {
                    errorDiv.innerHTML = '<div class="error-message">Ú©Ø¯ Ú¯Ø±ÙˆÙ‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª</div>';
                }
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡: ${error.message}</div>`;
            }
        });

        // User Profile
        userAvatar.addEventListener('click', () => {
            userProfileModal.classList.add('active');
        });

        userAvatarFallback.addEventListener('click', () => {
            userProfileModal.classList.add('active');
        });

        document.getElementById('closeUserProfile').addEventListener('click', () => {
            userProfileModal.classList.remove('active');
        });

        document.getElementById('userAvatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const compressed = await compressImage(file);
                document.getElementById('userAvatarPreview').src = compressed;
                document.getElementById('userAvatarPreview').style.display = 'block';
                document.getElementById('userAvatarPreviewFallback').style.display = 'none';
            }
        });

        document.getElementById('saveProfileBtn').addEventListener('click', async () => {
            const newDisplayName = document.getElementById('editDisplayName').value;
            const avatarInput = document.getElementById('userAvatarInput');
            
            try {
                const updates = {};
                
                if (newDisplayName) {
                    await updateProfile(currentUser, { displayName: newDisplayName });
                    updates.displayName = newDisplayName;
                }
                
                if (avatarInput.files[0]) {
                    const compressed = await compressImage(avatarInput.files[0]);
                    updates.avatar = compressed;
                }
                
                if (Object.keys(updates).length > 0) {
                    await update(ref(db, `users/${currentUser.uid}`), updates);
                    loadUserData();
                }
                
                userProfileModal.classList.remove('active');
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª: ' + error.message);
            }
        });

        // Group Info
        document.getElementById('groupInfoBtn').addEventListener('click', async () => {
            if (!currentGroupId) return;
            
            const groupRef = ref(db, `groups/${currentGroupId}`);
            const snapshot = await get(groupRef);
            const groupData = snapshot.val();
            
            document.getElementById('groupCodeDisplay').value = groupData.code;
            document.getElementById('memberCount').textContent = Object.keys(groupData.members || {}).length;
            
            if (groupData.avatar) {
                document.getElementById('editGroupAvatarPreview').src = groupData.avatar;
                document.getElementById('editGroupAvatarPreview').style.display = 'block';
                document.getElementById('editGroupAvatarPreviewFallback').style.display = 'none';
            } else {
                document.getElementById('editGroupAvatarPreview').style.display = 'none';
                document.getElementById('editGroupAvatarPreviewFallback').style.display = 'flex';
                document.getElementById('editGroupAvatarPreviewFallback').textContent = groupData.name.charAt(0).toUpperCase();
            }
            
            groupInfoModal.classList.add('active');
        });

        document.getElementById('closeGroupInfo').addEventListener('click', () => {
            groupInfoModal.classList.remove('active');
        });

        document.getElementById('copyGroupCodeBtn').addEventListener('click', () => {
            const codeInput = document.getElementById('groupCodeDisplay');
            codeInput.select();
            document.execCommand('copy');
            alert('Ú©Ø¯ Ú¯Ø±ÙˆÙ‡ Ú©Ù¾ÛŒ Ø´Ø¯!');
        });

        document.getElementById('editGroupAvatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && currentGroupId) {
                const compressed = await compressImage(file);
                await update(ref(db, `groups/${currentGroupId}`), { avatar: compressed });
                document.getElementById('editGroupAvatarPreview').src = compressed;
                document.getElementById('editGroupAvatarPreview').style.display = 'block';
                document.getElementById('editGroupAvatarPreviewFallback').style.display = 'none';
                loadUserGroups();
            }
        });

        // Leave Group
        document.getElementById('leaveGroupBtn').addEventListener('click', async () => {
            if (!currentGroupId) return;
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
                await remove(ref(db, `groups/${currentGroupId}/members/${currentUser.uid}`));
                await remove(ref(db, `userGroups/${currentUser.uid}/${currentGroupId}`));
                currentGroupId = null;
                welcomeScreen.classList.remove('hidden');
                chatScreen.classList.add('hidden');
            }
        });

        // Delete Group
        document.getElementById('deleteGroupBtn').addEventListener('click', async () => {
            if (!currentGroupId) return;
            
            const groupRef = ref(db, `groups/${currentGroupId}`);
            const snapshot = await get(groupRef);
            const groupData = snapshot.val();
            
            if (groupData.createdBy !== currentUser.uid) {
                alert('ÙÙ‚Ø· Ø³Ø§Ø²Ù†Ø¯Ù‡ Ú¯Ø±ÙˆÙ‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù†Ø¯');
                return;
            }
            
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª!')) {
                // Remove group from all members
                const members = groupData.members || {};
                for (const memberId in members) {
                    await remove(ref(db, `userGroups/${memberId}/${currentGroupId}`));
                }
                
                // Delete messages
                await remove(ref(db, `messages/${currentGroupId}`));
                
                // Delete group
                await remove(groupRef);
                
                currentGroupId = null;
                welcomeScreen.classList.remove('hidden');
                chatScreen.classList.add('hidden');
            }
        });

        // AI Assistant
        aiAssistantBtn.addEventListener('click', () => {
            aiChatModal.classList.add('active');
        });

        aiChatClose.addEventListener('click', () => {
            aiChatModal.classList.remove('active');
        });

        // Send AI Message
        async function sendAIMessage() {
            const userMessage = aiMessageInput.value.trim();
            if (!userMessage) return;
            
            // Add user message to UI
            addAIMessage(userMessage, true);
            aiMessageInput.value = '';
            aiMessageInput.style.height = 'auto';
            
            // Show thinking indicator
            showAIThinking();
            
            try {
                const response = await sendMessageToAI(userMessage);
                hideAIThinking();
                addAIMessage(response, false);
            } catch (error) {
                hideAIThinking();
                let errorMessage = 'âŒ Ù…ØªØ£Ø³ÙÙ…ØŒ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯:\n\n';
                
                if (error.message.includes('API_KEY_INVALID')) {
                    errorMessage += 'ğŸ”‘ **Ú©Ù„ÛŒØ¯ API Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª**\n\n';
                    errorMessage += 'Ù„Ø·ÙØ§Ù‹:\n';
                    errorMessage += '1. Ø¨Ù‡ Google AI Studio Ø¨Ø±ÙˆÛŒØ¯\n';
                    errorMessage += '2. ÛŒÚ© Ú©Ù„ÛŒØ¯ API Ø¬Ø¯ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯\n';
                    errorMessage += '3. Ú©Ù„ÛŒØ¯ Ø±Ø§ Ø¯Ø± Ú©Ø¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯';
                } else if (error.message.includes('QUOTA_EXCEEDED')) {
                    errorMessage += 'âš ï¸ **Ø³Ù‡Ù…ÛŒÙ‡ API ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª**\n\n';
                    errorMessage += 'Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ú©Ù„ÛŒØ¯ API Ø¬Ø¯ÛŒØ¯ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯.';
                } else if (error.message.includes('NETWORK')) {
                    errorMessage += 'ğŸŒ **Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª**\n\n';
                    errorMessage += 'Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.';
                } else {
                    errorMessage += `ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§:\n${error.message}`;
                }
                
                addAIMessage(errorMessage, false);
                console.error('AI Error Details:', error);
            }
        }

        aiSendBtn.addEventListener('click', sendAIMessage);
        aiMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIMessage();
            }
        });

        // Auto-resize AI textarea
        aiMessageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        // Send Message to Gemini AI
        async function sendMessageToAI(userMessage) {
            try {
                const chat = aiModel.startChat({
                    history: aiChatHistory,
                    generationConfig: {
                        maxOutputTokens: 1000,
                    },
                });

                const result = await chat.sendMessage(userMessage);
                const response = await result.response;
                const aiResponse = response.text();

                // Update chat history
                aiChatHistory.push({
                    role: "user",
                    parts: [{ text: userMessage }],
                });
                aiChatHistory.push({
                    role: "model",
                    parts: [{ text: aiResponse }],
                });

                return aiResponse;
            } catch (error) {
                console.error('Gemini AI Error:', error);
                throw error;
            }
        }

        // Add AI Message to UI
        function addAIMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message' + (isUser ? '' : ' ai');
            
            const avatar = isUser ? 'ğŸ‘¤' : 'ğŸ¤–';
            const name = isUser ? 'Ø´Ù…Ø§' : 'Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ';
            const time = new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-header">
                        <strong>${name}</strong>
                        <span>${time}</span>
                    </div>
                    <div class="message-text">${text.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            
            aiMessagesContainer.appendChild(messageDiv);
            aiMessagesContainer.scrollTop = aiMessagesContainer.scrollHeight;
        }

        // Show/Hide AI Thinking
        function showAIThinking() {
            aiThinking.classList.add('active');
            aiMessagesContainer.scrollTop = aiMessagesContainer.scrollHeight;
        }

        function hideAIThinking() {
            aiThinking.classList.remove('active');
        }

        // Image Compression
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const maxSize = 200;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Error Messages
        function getErrorMessage(errorCode) {
            const messages = {
                'auth/email-already-in-use': 'Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª',
                'auth/invalid-email': 'Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª',
                'auth/operation-not-allowed': 'Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª',
                'auth/weak-password': 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 6 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯',
                'auth/user-disabled': 'Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª',
                'auth/user-not-found': 'Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯',
                'auth/wrong-password': 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª',
                'auth/invalid-credential': 'Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª'
            };
            return messages[errorCode] || errorCode;
        }

        // Close modals on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                createGroupModal.classList.remove('active');
                joinGroupModal.classList.remove('active');
                userProfileModal.classList.remove('active');
                groupInfoModal.classList.remove('active');
                aiChatModal.classList.remove('active');
            }
        });

        // Close modals on outside click
        [createGroupModal, joinGroupModal, userProfileModal, groupInfoModal, aiChatModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
