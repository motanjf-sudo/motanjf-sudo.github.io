<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOVA Chat</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:sans-serif;
  background:#0f172a;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.app{
  width:100%;
  max-width:420px;
  height:100vh;
  background:#020617;
  display:flex;
  flex-direction:column;
}
header{
  padding:12px;
  text-align:center;
  background:#020617;
  font-weight:bold;
}
.screen{display:none;flex:1;flex-direction:column}
.screen.active{display:flex}
input,button{
  padding:12px;
  border:none;
  border-radius:6px;
  margin-bottom:10px;
}
button{background:#38bdf8;font-weight:bold}
.list button{margin-bottom:6px;width:100%}
#messages{flex:1;padding:10px;overflow-y:auto}
.msg{
  background:#1e293b;
  padding:8px;
  border-radius:6px;
  margin-bottom:8px;
  position:relative;
}
.msg:hover .del{display:block}
.del{
  position:absolute;
  top:6px;
  right:6px;
  cursor:pointer;
  display:none;
}
.time{font-size:11px;opacity:.6}
footer{display:flex;padding:10px}
footer input{flex:1;margin-right:6px}
</style>
</head>

<body>

<div class="app">

<!-- LOGIN / SIGNUP -->
<div id="auth" class="screen active">
<header>NOVA ‚Äì Login / Sign up</header>
<div style="padding:20px">
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login / Sign up</button>
</div>
</div>

<!-- GROUPS -->
<div id="groups" class="screen">
<header>Groups</header>
<div style="padding:10px">
<input id="gname" placeholder="New group name">
<input id="gpass" placeholder="Group password">
<button onclick="createGroup()">Create group</button>
<hr>
<div class="list" id="groupList"></div>
</div>
</div>

<!-- CHAT -->
<div id="chat" class="screen">
<header id="chatTitle"></header>
<div id="messages"></div>
<footer>
<input id="input" placeholder="Ÿæ€åÿßŸÖ ÿ®ŸÜŸà€åÿ≥...">
<button onclick="send()">ÿßÿ±ÿ≥ÿßŸÑ</button>
</footer>
</div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyDybhWHcf85KDoBYdFWYIPCH0df3oKy7vU",
  authDomain:"nova-chat-408a2.firebaseapp.com",
  databaseURL:"https://nova-chat-408a2-default-rtdb.firebaseio.com",
  projectId:"nova-chat-408a2"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let currentUser="",currentGroup="",msgRef=null;

// LOGIN
function login(){
  currentUser=user.value.trim();
  if(!currentUser)return alert("Username ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ");
  auth.classList.remove("active");
  groups.classList.add("active");
  loadGroups();
}

// LOAD GROUPS
function loadGroups(){
  groupList.innerHTML="";
  db.ref("groups").on("child_added",snap=>{
    const g=snap.key;
    const btn=document.createElement("button");
    btn.innerText=g;
    btn.onclick=()=>joinGroup(g);
    groupList.appendChild(btn);
  });
}

// CREATE GROUP
function createGroup(){
  if(!gname.value||!gpass.value)return;
  db.ref("groups/"+gname.value).set({
    password:gpass.value,
    owner:currentUser
  });
  gname.value="";
  gpass.value="";
}

// JOIN GROUP
function joinGroup(name){
  const p=prompt("Group password:");
  db.ref("groups/"+name).once("value",snap=>{
    if(!snap.exists()||snap.val().password!==p){
      alert("Wrong password");
    }else{
      enterChat(name);
    }
  });
}

// CHAT
function enterChat(group){
  currentGroup=group;
  groups.classList.remove("active");
  chat.classList.add("active");
  chatTitle.innerText=group;
  messages.innerHTML="";
  msgRef=db.ref("messages/"+group);
  msgRef.off();
  msgRef.on("child_added",snap=>{
    const m=snap.val();
    const div=document.createElement("div");
    div.className="msg";
    div.innerHTML=`
      <b>${m.user}</b>: ${m.text}
      <span class="del" onclick="delMsg('${snap.key}','${m.user}')">üóëÔ∏è</span>
      <div class="time">${m.time}</div>`;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
  });
}

// SEND
function send(){
  if(!input.value)return;
  const t=new Date();
  msgRef.push({
    user:currentUser,
    text:input.value,
    time:t.getHours()+":"+String(t.getMinutes()).padStart(2,"0")
  });
  input.value="";
}

// DELETE MESSAGE
function delMsg(id,user){
  if(user!==currentUser)return alert("ŸÅŸÇÿ∑ ÿµÿßÿ≠ÿ® Ÿæ€åÿßŸÖ ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ≠ÿ∞ŸÅ ⁄©ŸÜÿØ");
  msgRef.child(id).remove();
}

// ENTER KEY
input.addEventListener("keydown",e=>{
  if(e.key==="Enter")send();
});
</script>

</body>
</html>
