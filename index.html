<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Amirtaha Chat - Ú†Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ùˆ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ú©Ø¯ Ø´Ù…Ø§ */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #818cf8;
            --secondary: #8b5cf6; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --bg-primary: #0f172a; --bg-secondary: #1e293b;
            --bg-tertiary: #334155; --text-primary: #f1f5f9; --text-secondary: #cbd5e1;
            --border: #475569; --shadow: rgba(0, 0, 0, 0.3);
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 20px; color: var(--text-primary); overflow: hidden; }
        .container { width: 100%; max-width: 1400px; height: 90vh; background: var(--bg-primary); border-radius: 20px; box-shadow: 0 20px 60px var(--shadow); overflow: hidden; display: flex; flex-direction: column; position: relative; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ */
        .ai-item { background: linear-gradient(135deg, #4f46e5, #9333ea) !important; border: none !important; margin-bottom: 15px !important; }
        .ai-badge { background: #fff; color: #4f46e5; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .ai-msg { border-right: 4px solid var(--secondary) !important; background: #2d3748 !important; }
        .typing-ai { font-style: italic; color: var(--text-secondary); font-size: 0.9rem; padding: 10px; }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Auth Ùˆ Ú†Øª Ø´Ù…Ø§ (Ø¨Ø±Ú¯Ø±ÙØªÙ‡ Ø§Ø² ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ) */
        .auth-container { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; overflow-y: auto; }
        .auth-box { background: var(--bg-secondary); padding: 40px; border-radius: 20px; width: 100%; max-width: 480px; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 30px; background: var(--bg-tertiary); padding: 6px; border-radius: 14px; }
        .auth-tab { flex: 1; padding: 15px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; border-radius: 10px; font-weight: 600; transition: 0.3s; }
        .auth-tab.active { background: var(--primary); color: white; }
        .auth-form { display: none; } .auth-form.active { display: block; }
        .form-group { margin-bottom: 22px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 16px; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 12px; color: white; }
        .btn { width: 100%; padding: 17px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; }
        .avatar-preview-box { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; }
        .avatar-preview-img { width: 60px; height: 60px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; overflow: hidden; }
        .avatar-preview-img img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Chat Layout */
        .chat-container { display: none; height: 100%; flex-direction: row; }
        .chat-container.active { display: flex; }
        .sidebar { width: 340px; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; transition: 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-primary); }
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .sidebar-actions { padding: 16px; display: flex; gap: 10px; border-bottom: 1px solid var(--border); }
        .action-btn { flex: 1; padding: 14px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: white; cursor: pointer; font-size: 0.9rem; }
        .groups-list { flex: 1; overflow-y: auto; padding: 12px; }
        .group-item { padding: 16px; margin-bottom: 10px; background: var(--bg-tertiary); border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.3s; }
        .group-item.active { background: linear-gradient(135deg, var(--primary), var(--secondary)); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4); }
        
        .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); position: relative; }
        .chat-header { padding: 20px 24px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); display: flex; align-items: center; gap: 16px; }
        .messages-container { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; }
        .message { max-width: 70%; padding: 14px 18px; border-radius: 18px; display: flex; gap: 12px; position: relative; }
        .message.own { align-self: flex-end; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; flex-direction: row-reverse; }
        .message.other { align-self: flex-start; background: var(--bg-secondary); color: white; border: 1px solid var(--border); }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary-light); overflow: hidden; }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .input-area { padding: 18px 24px; border-top: 1px solid var(--border); background: var(--bg-secondary); }
        .input-wrapper-container { display: flex; gap: 12px; align-items: flex-end; }
        .message-input { flex: 1; padding: 16px; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 12px; color: white; resize: none; max-height: 140px; }
        .send-btn { padding: 16px 26px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; }

        /* Emoji & Modals */
        .emoji-btn { padding: 14px; background: var(--bg-tertiary); border-radius: 12px; cursor: pointer; font-size: 1.5rem; border: 1px solid var(--border); }
        .emoji-panel { position: absolute; bottom: 100px; right: 24px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 16px; width: 320px; display: none; z-index: 2000; }
        .emoji-panel.show { display: block; }
        .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .emoji-item { cursor: pointer; font-size: 1.4rem; text-align: center; padding: 5px; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-secondary); padding: 32px; border-radius: 20px; width: 100%; max-width: 500px; }
        
        .error-message { color: var(--danger); font-size: 0.9rem; margin-top: 10px; display: none; }
        .error-message.show { display: block; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; right: -100%; width: 85%; height: 100%; }
            .sidebar.show { right: 0; }
            .container { height: 100vh; border-radius: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-container" id="authContainer">
            <div class="auth-box">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">ÙˆØ±ÙˆØ¯</button>
                    <button class="auth-tab" data-tab="signup">Ø«Ø¨Øª Ù†Ø§Ù…</button>
                </div>
                <form id="loginForm" class="auth-form active">
                    <div class="form-group"><input type="text" id="loginUsername" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" required></div>
                    <div class="form-group"><input type="password" id="loginPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required></div>
                    <div class="error-message" id="loginError"></div>
                    <button type="submit" class="btn">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</button>
                </form>
                <form id="signupForm" class="auth-form">
                    <div class="form-group"><input type="text" id="signupUsername" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯" required></div>
                    <div class="form-group"><input type="password" id="signupPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ±)" minlength="6" required></div>
                    <div class="form-group">
                        <div class="avatar-preview-box" id="signupAvatarBtn">
                            <div class="avatar-preview-img" id="signupAvatarPreview">ğŸ‘¤</div>
                            <div>Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</div>
                        </div>
                        <input type="file" id="signupAvatarInput" style="display:none" accept="image/*">
                    </div>
                    <div class="error-message" id="signupError"></div>
                    <button type="submit" class="btn">Ø³Ø§Ø®Øª Ø­Ø³Ø§Ø¨</button>
                </form>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="user-avatar" id="myAvatarDisplay">U</div>
                    <div id="userDisplayName" style="font-weight: bold;">Ú©Ø§Ø±Ø¨Ø±</div>
                    <button onclick="location.reload()" style="background:none; border:none; color:var(--danger); cursor:pointer;">Ø®Ø±ÙˆØ¬</button>
                </div>
                <div class="sidebar-actions">
                    <button class="action-btn" id="createGroupBtn">Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯</button>
                    <button class="action-btn" id="joinGroupBtn">Ù¾ÛŒÙˆØ³ØªÙ†</button>
                </div>
                <div class="groups-list">
                    <div class="group-item ai-item" id="aiChatTab" onclick="switchToAI()">
                        <div class="user-avatar">ğŸ¤–</div>
                        <div class="group-info">
                            <div class="group-name">Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Amirtaha <span class="ai-badge">AI</span></div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">Ø¢Ù†Ù„Ø§ÛŒÙ† Ùˆ Ù‡ÙˆØ´Ù…Ù†Ø¯</div>
                        </div>
                    </div>
                    <div id="groupsList"></div>
                </div>
            </aside>

            <main class="main-chat">
                <div class="chat-header">
                    <button id="mobileToggle" style="background:none; border:none; color:white; font-size:1.5rem; display:none;">â˜°</button>
                    <div class="user-avatar" id="chatHeaderAvatar">?</div>
                    <h2 id="currentGroupName">Ø§Ù†ØªØ®Ø§Ø¨ Ú†Øª</h2>
                </div>
                <div class="messages-container" id="messagesContainer">
                    <div style="text-align:center; padding:40px; opacity:0.5;">ÛŒÚ© Ú†Øª Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                </div>
                <div class="input-area">
                    <div class="input-wrapper-container">
                        <button class="emoji-btn" id="emojiBtn">ğŸ˜Š</button>
                        <textarea class="message-input" id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." rows="1"></textarea>
                        <button class="send-btn" id="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
                <div class="emoji-panel" id="emojiPanel">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>
            </main>
        </div>
    </div>

    <div class="modal" id="groupModal">
        <div class="modal-content">
            <h3 id="modalTitle" style="margin-bottom:20px;">Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡</h3>
            <div class="form-group"><input type="text" id="groupNameInput" placeholder="Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡"></div>
            <div class="form-group"><input type="password" id="groupPassInput" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ú¯Ø±ÙˆÙ‡"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn" id="modalSubmit">ØªØ§ÛŒÛŒØ¯</button>
                <button class="btn" style="background:var(--bg-tertiary);" onclick="closeModals()">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ùˆ ÙØ§ÛŒØ±Ø¨ÛŒØ³
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAAcLK4sFnrpx8tlltEBRoTV_-VYMndrGQ",
            authDomain: "nova-chat-f73f0.firebaseapp.com",
            databaseURL: "https://nova-chat-f73f0-default-rtdb.firebaseio.com",
            projectId: "nova-chat-f73f0",
            storageBucket: "nova-chat-f73f0.firebasestorage.app",
            messagingSenderId: "1067975852327",
            appId: "1:1067975852327:web:97d3f998e8f0570dd4a902"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Ú©Ù„ÛŒØ¯ API Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ú©Ù‡ ÙØ±Ø³ØªØ§Ø¯ÛŒØ¯
        const AI_KEY = "AIzaSyCfwY1VyyHfoWqjLtP3a4zJNAJkP04boKM";
        const genAI = new GoogleGenerativeAI(AI_KEY);
        const aiModel = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        let currentUser = null;
        let currentGroupId = null;
        let isAIChatActive = false;
        let myData = {};
        const messageEmojis = ['ğŸ˜€','ğŸ˜‚','ğŸ˜Š','ğŸ˜','ğŸ¤”','ğŸ‘','ğŸ”¥','â¤ï¸','âœ¨','âœ”ï¸','âŒ','ğŸ‘‹','ğŸš€','ğŸŒ™','ğŸ’»','ğŸ“±'];

        // --- Auth Logic ---
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.auth-tab, .auth-form').forEach(el => el.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Form').classList.add('active');
            }
        });

        document.getElementById('signupAvatarBtn').onclick = () => document.getElementById('signupAvatarInput').click();
        
        let signupAvatarData = "";
        document.getElementById('signupAvatarInput').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                signupAvatarData = reader.result;
                document.getElementById('signupAvatarPreview').innerHTML = `<img src="${signupAvatarData}">`;
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('signupForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupUsername').value;
            const pass = document.getElementById('signupPassword').value;
            try {
                const res = await auth.createUserWithEmailAndPassword(name + "@amirtaha.chat", pass);
                await database.ref('users/' + res.user.uid).set({
                    username: name,
                    avatar: signupAvatarData,
                    createdAt: Date.now()
                });
                startApp(res.user);
            } catch (err) { alert(err.message); }
        };

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('loginUsername').value;
            const pass = document.getElementById('loginPassword').value;
            try {
                const res = await auth.signInWithEmailAndPassword(name + "@amirtaha.chat", pass);
                startApp(res.user);
            } catch (err) { alert("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"); }
        };

        async function startApp(user) {
            currentUser = user;
            const snapshot = await database.ref('users/' + user.uid).once('value');
            myData = snapshot.val();
            document.getElementById('userDisplayName').textContent = myData.username;
            if(myData.avatar) document.getElementById('myAvatarDisplay').innerHTML = `<img src="${myData.avatar}">`;
            
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('chatContainer').classList.add('active');
            loadGroups();
            initEmojis();
        }

        // --- Chat Logic ---
        function loadGroups() {
            database.ref('groups').on('value', snap => {
                const list = document.getElementById('groupsList');
                list.innerHTML = "";
                snap.forEach(child => {
                    const g = child.val();
                    const item = document.createElement('div');
                    item.className = 'group-item';
                    item.innerHTML = `<div class="user-avatar">${g.name[0]}</div><div>${g.name}</div>`;
                    item.onclick = () => switchGroup(child.key, g);
                    list.appendChild(item);
                });
            });
        }

        window.switchToAI = () => {
            isAIChatActive = true;
            currentGroupId = "AI_MODE";
            document.querySelectorAll('.group-item').forEach(el => el.classList.remove('active'));
            document.getElementById('aiChatTab').classList.add('active');
            document.getElementById('currentGroupName').textContent = "Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Amirtaha";
            document.getElementById('chatHeaderAvatar').innerHTML = "ğŸ¤–";
            document.getElementById('messagesContainer').innerHTML = `<div class="message other ai-msg">Ø³Ù„Ø§Ù… ${myData.username}! Ù…Ù† Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù… ØªØ§ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§ØªØª Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù…. Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ</div>`;
        };

        function switchGroup(id, data) {
            isAIChatActive = false;
            currentGroupId = id;
            document.querySelectorAll('.group-item, .ai-item').forEach(el => el.classList.remove('active'));
            document.getElementById('currentGroupName').textContent = data.name;
            document.getElementById('chatHeaderAvatar').innerHTML = data.name[0];
            
            database.ref('messages/' + id).off();
            document.getElementById('messagesContainer').innerHTML = "";
            database.ref('messages/' + id).on('child_added', snap => {
                const msg = snap.val();
                appendMsg(msg.text, msg.userId === currentUser.uid ? 'own' : 'other', msg.username, msg.avatar);
            });
        }

        function appendMsg(text, type, sender, avatar) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');
            div.className = `message ${type} ${isAIChatActive && type === 'other' ? 'ai-msg' : ''}`;
            const avatarHtml = avatar ? `<img src="${avatar}">` : (sender ? sender[0] : '?');
            div.innerHTML = `
                <div class="message-avatar">${avatarHtml}</div>
                <div class="message-content-wrapper">
                    <div style="font-size:0.7rem; opacity:0.7; margin-bottom:4px;">${sender}</div>
                    <div class="message-content">${text}</div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- Sending Messages ---
        document.getElementById('sendBtn').onclick = async () => {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if(!text || !currentGroupId) return;
            
            input.value = "";
            
            if(isAIChatActive) {
                appendMsg(text, 'own', 'Ø´Ù…Ø§', myData.avatar);
                const typingDiv = document.createElement('div');
                typingDiv.className = "typing-ai";
                typingDiv.textContent = "Amirtaha AI Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...";
                document.getElementById('messagesContainer').appendChild(typingDiv);
                
                try {
                    const result = await aiModel.generateContent(text);
                    typingDiv.remove();
                    appendMsg(result.response.text(), 'other', 'Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ', null);
                } catch (e) { typingDiv.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"; }
            } else {
                database.ref('messages/' + currentGroupId).push({
                    text: text,
                    userId: currentUser.uid,
                    username: myData.username,
                    avatar: myData.avatar || "",
                    timestamp: Date.now()
                });
            }
        };

        // --- UI Helpers ---
        function initEmojis() {
            const grid = document.getElementById('emojiGrid');
            messageEmojis.forEach(e => {
                const span = document.createElement('span');
                span.className = "emoji-item";
                span.textContent = e;
                span.onclick = () => {
                    document.getElementById('messageInput').value += e;
                    document.getElementById('emojiPanel').classList.remove('show');
                };
                grid.appendChild(span);
            });
        }

        document.getElementById('emojiBtn').onclick = (e) => {
            e.stopPropagation();
            document.getElementById('emojiPanel').classList.toggle('show');
        };

        document.getElementById('createGroupBtn').onclick = () => {
            document.getElementById('groupModal').classList.add('show');
            document.getElementById('modalTitle').textContent = "Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯";
            document.getElementById('modalSubmit').onclick = async () => {
                const name = document.getElementById('groupNameInput').value;
                const pass = document.getElementById('groupPassInput').value;
                if(name && pass) {
                    await database.ref('groups').push({ name, pass, owner: currentUser.uid });
                    closeModals();
                }
            };
        };

        document.getElementById('joinGroupBtn').onclick = () => {
            document.getElementById('groupModal').classList.add('show');
            document.getElementById('modalTitle').textContent = "Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡";
            document.getElementById('modalSubmit').onclick = async () => {
                const name = document.getElementById('groupNameInput').value;
                const pass = document.getElementById('groupPassInput').value;
                const snap = await database.ref('groups').once('value');
                let found = false;
                snap.forEach(c => {
                    if(c.val().name === name && c.val().pass === pass) {
                        switchGroup(c.key, c.val());
                        found = true;
                    }
                });
                if(!found) alert("Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");
                closeModals();
            };
        };

        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
        
        // Ø¨Ø³ØªÙ† Ù…Ù†ÙˆÙ‡Ø§ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ†
        window.onclick = () => document.getElementById('emojiPanel').classList.remove('show');

        console.log("âœ… Ø³ÛŒØ³ØªÙ… Ú†Øª Amirtaha ÙØ¹Ø§Ù„ Ø´Ø¯.");
    </script>
</body>
</html>
