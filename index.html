<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova Chat</title>

<style>
body {
    margin: 0;
    font-family: sans-serif;
    background: #f4f4f4;
}
#login, #app {
    padding: 15px;
}
input, button {
    padding: 10px;
    margin: 5px 0;
    width: 100%;
}
button {
    background: #25D366;
    border: none;
    color: white;
    cursor: pointer;
}
#groups, #messages {
    border: 1px solid #ccc;
    background: white;
    padding: 10px;
    height: 200px;
    overflow-y: auto;
}
.message {
    margin: 5px 0;
    padding: 5px;
    background: #e9ffe9;
    border-radius: 5px;
}
.group {
    padding: 5px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
}
</style>
</head>

<body>

<div id="login">
    <h2>Nova Chat</h2>
    <input id="username" placeholder="نام کاربری">
    <button onclick="enter()">ورود</button>
</div>

<div id="app" style="display:none;">
    <h3 id="welcome"></h3>

    <h4>ساخت گروه</h4>
    <input id="newGroupName" placeholder="نام گروه">
    <input id="newGroupPass" placeholder="رمز گروه">
    <button onclick="createGroup()">ساخت گروه</button>

    <h4>گروه‌ها</h4>
    <div id="groups"></div>

    <h4 id="currentGroupTitle"></h4>
    <div id="messages"></div>

    <input id="msgInput" placeholder="پیام..." onkeydown="if(event.key==='Enter')sendMessage()">
    <button onclick="sendMessage()">ارسال</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    databaseURL: "https://PROJECT_ID-default-rtdb.firebaseio.com",
    projectId: "PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = "";
let currentGroup = "";

window.enter = function () {
    const u = document.getElementById("username").value.trim();
    if (!u) return alert("نام کاربری وارد کن");
    currentUser = u;
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("welcome").innerText = "سلام " + u;
    loadGroups();
};

window.createGroup = function () {
    const name = newGroupName.value.trim();
    const pass = newGroupPass.value.trim();
    if (name.length < 1 || pass.length < 3) return alert("اطلاعات ناقص");

    const g = push(ref(db, "groups"));
    set(g, {
        name,
        pass
    });
};

function loadGroups() {
    onValue(ref(db, "groups"), snap => {
        groups.innerHTML = "";
        snap.forEach(g => {
            const d = g.val();
            const div = document.createElement("div");
            div.className = "group";
            div.innerText = d.name;
            div.onclick = () => joinGroup(g.key, d.name);
            groups.appendChild(div);
        });
    });
}

function joinGroup(id, name) {
    const p = prompt("رمز گروه:");
    if (!p) return;
    onValue(ref(db, "groups/" + id), snap => {
        if (!snap.exists()) return;
        if (snap.val().pass !== p) return alert("رمز اشتباه");
        currentGroup = id;
        currentGroupTitle.innerText = name;
        loadMessages();
    }, { onlyOnce: true });
}

function loadMessages() {
    onValue(ref(db, "messages/" + currentGroup), snap => {
        messages.innerHTML = "";
        snap.forEach(m => {
            const d = m.val();
            const div = document.createElement("div");
            div.className = "message";
            div.innerText = d.user + ": " + d.text;
            messages.appendChild(div);
        });
        messages.scrollTop = messages.scrollHeight;
    });
}

window.sendMessage = function () {
    if (!currentGroup) return alert("گروه انتخاب نشده");
    const text = msgInput.value.trim();
    if (!text) return;
    push(ref(db, "messages/" + currentGroup), {
        user: currentUser,
        text,
        time: Date.now()
    });
    msgInput.value = "";
};
</script>

</body>
</html>
