<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOVA Chat</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:sans-serif;
  background:#0f172a;
  color:white;
}
.app{
  display:flex;
  height:100vh;
}

/* -------- SIDEBAR (GROUPS) -------- */
.sidebar{
  width:220px;
  background:#020617;
  padding:10px;
  display:flex;
  flex-direction:column;
}
.sidebar h3{
  margin-top:0;
  text-align:center;
}
.sidebar button{
  margin-bottom:8px;
  padding:8px;
  border:none;
  border-radius:6px;
  background:#1e293b;
  color:white;
}
.sidebar button:hover{
  background:#38bdf8;
  color:black;
}

/* -------- CHAT -------- */
.chat{
  flex:1;
  display:flex;
  flex-direction:column;
}
header{
  padding:12px;
  background:#020617;
  text-align:center;
  font-weight:bold;
}
#messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
}
.msg{
  background:#1e293b;
  padding:8px;
  border-radius:6px;
  margin-bottom:8px;
}
.time{
  font-size:11px;
  opacity:.6;
}
footer{
  display:flex;
  padding:10px;
  background:#020617;
}
footer input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:6px;
}
footer button{
  margin-left:6px;
  padding:10px;
}

/* -------- LOGIN -------- */
.login{
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.login div{
  background:#020617;
  padding:20px;
  border-radius:10px;
  width:280px;
}
.login input, .login button{
  width:100%;
  margin-bottom:10px;
  padding:10px;
}

/* -------- MOBILE -------- */
@media(max-width:700px){
  .app{flex-direction:column}
  .sidebar{width:100%;flex-direction:row;overflow-x:auto}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="login">
  <div>
    <h3>NOVA Login</h3>
    <input id="user" placeholder="Username">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="loginUser()">Login / Sign up</button>
  </div>
</div>

<!-- APP -->
<div class="app" id="app" style="display:none">

  <!-- GROUPS -->
  <div class="sidebar">
    <h3>Groups</h3>
    <button onclick="newGroup()">➕ New group</button>
    <div id="groupList"></div>
  </div>

  <!-- CHAT -->
  <div class="chat">
    <header id="chatTitle">Select a group</header>
    <div id="messages"></div>
    <footer>
      <input id="input" placeholder="پیام بنویس...">
      <button onclick="send()">ارسال</button>
    </footer>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyDybhWHcf85KDoBYdFWYIPCH0df3oKy7vU",
  authDomain:"nova-chat-408a2.firebaseapp.com",
  databaseURL:"https://nova-chat-408a2-default-rtdb.firebaseio.com",
  projectId:"nova-chat-408a2"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let currentUser="";
let currentGroup="";
let msgRef=null;

/* -------- LOGIN -------- */
function loginUser(){
  if(!user.value)return;
  currentUser=user.value;
  login.style.display="none";
  app.style.display="flex";
  loadGroups();
}

/* -------- GROUPS -------- */
function loadGroups(){
  groupList.innerHTML="";
  db.ref("userGroups/"+currentUser).on("child_added",snap=>{
    const g=snap.key;
    const btn=document.createElement("button");
    btn.innerText=g;
    btn.onclick=()=>openGroup(g);
    groupList.appendChild(btn);
  });
}

function newGroup(){
  const name=prompt("Group name:");
  const pass=prompt("Group password:");
  if(!name||!pass)return;

  db.ref("groups/"+name).set({password:pass});
  db.ref("userGroups/"+currentUser+"/"+name).set(true);
}

function openGroup(name){
  const pass=prompt("Group password:");
  db.ref("groups/"+name).once("value",snap=>{
    if(!snap.exists()||snap.val().password!==pass){
      alert("Wrong password");
    }else{
      currentGroup=name;
      chatTitle.innerText=name;
      messages.innerHTML="";
      msgRef=db.ref("messages/"+name);
      msgRef.off();
      msgRef.on("child_added",s=>{
        const m=s.val();
        const d=document.createElement("div");
        d.className="msg";
        d.innerHTML=`<b>${m.user}</b>: ${m.text}<br><span class="time">${m.time}</span>`;
        messages.appendChild(d);
        messages.scrollTop=messages.scrollHeight;
      });
    }
  });
}

/* -------- SEND -------- */
function send(){
  if(!input.value||!currentGroup)return;
  const t=new Date();
  msgRef.push({
    user:currentUser,
    text:input.value,
    time:t.getHours()+":"+String(t.getMinutes()).padStart(2,"0")
  });
  input.value="";
}

input.addEventListener("keydown",e=>{
  if(e.key==="Enter")send();
});
</script>

</body>
</html>
